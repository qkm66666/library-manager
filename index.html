<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图书管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans SC', sans-serif;
        }
        .book-card {
            transition: all 0.3s ease;
        }
        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .blur-background {
            filter: blur(2px);
            transition: filter 0.3s ease;
        }
        .modal-container {
            position: relative;
            z-index: 10; /* 确保模态框内容在模糊效果之上 */
            filter: none; /* 防止模态框内容被模糊 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- 将主要内容包裹在一个容器中 -->
    <div id="mainContent">
        <!-- 导航栏 -->
        <nav class="bg-blue-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-book text-2xl"></i>
                    <h1 class="text-2xl font-bold">图书管理系统</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="openAddModal()" class="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-blue-50 transition flex items-center">
                        <i class="fas fa-plus mr-2"></i>
                        <span id="add-btn-text">添加图书</span>
                    </button>
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="搜索图书..." class="px-4 py-2 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-300" onkeyup="if(event.keyCode===13) searchData()" />
                        <button onclick="searchData()" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-blue-600 hover:text-blue-800">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <!-- 高级搜索按钮 -->
                    <button onclick="openAdvancedSearch()" class="bg-green-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-600 transition flex items-center">
                        <i class="fas fa-filter mr-2"></i>
                        高级搜索
                    </button>
                </div>
            </div>
        </nav>

        <!-- 标签页导航 -->
        <div class="bg-white shadow-md">
            <div class="container mx-auto">
                <div class="flex border-b border-gray-300">
                    <button onclick="switchView('books')" id="tab-books" class="tab-btn text-blue-600 border-b-2 border-blue-600 py-2 px-4 font-semibold">图书管理</button>
                    <button onclick="switchView('readers')" id="tab-readers" class="tab-btn text-gray-500 py-2 px-4 font-semibold hover:text-blue-600">读者管理</button>
                    <button onclick="switchView('records')" id="tab-records" class="tab-btn text-gray-500 py-2 px-4 font-semibold hover:text-blue-600">借阅记录</button>
                </div>
            </div>
        </div>

        <!-- 主要内容区 -->
        <div class="container mx-auto px-4 py-8">
            <!-- Tab navigation -->
            <div class="mb-8">
                <!-- 统计卡片 -->
                <div id="stats-cards" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow flex items-center">
                        <div class="bg-blue-100 p-3 rounded-full mr-4">
                            <i class="fas fa-book-open text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500">总图书数</p>
                            <h3 class="text-2xl font-bold" id="totalBooks">0</h3>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow flex items-center">
                        <div class="bg-green-100 p-3 rounded-full mr-4">
                            <i class="fas fa-check-circle text-green-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500">可借阅</p>
                            <h3 class="text-2xl font-bold" id="availableBooks">0</h3>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow flex items-center">
                        <div class="bg-red-100 p-3 rounded-full mr-4">
                            <i class="fas fa-times-circle text-red-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500">已借出</p>
                            <h3 class="text-2xl font-bold" id="borrowedBooks">0</h3>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow flex items-center">
                        <div class="bg-yellow-100 p-3 rounded-full mr-4">
                            <i class="fas fa-star text-yellow-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-gray-500">热门类别</p>
                            <h3 class="text-2xl font-bold" id="popularCategory">-</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Books View -->
            <div id="booksView">
                <!-- 图书列表 -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h2 class="text-xl font-semibold">图书列表</h2>
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center">
                                <label class="mr-2 text-gray-600">每页:</label>
                                <select id="itemsPerPage" class="border rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-300" onchange="changeItemsPerPage()">
                                    <option value="5">5</option>
                                    <option value="10" selected>10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button id="prevPage" class="px-3 py-1 border rounded disabled:opacity-50" disabled onclick="previousPage()">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <span id="pageInfo">1 / 1</span>
                                <button id="nextPage" class="px-3 py-1 border rounded disabled:opacity-50" disabled onclick="nextPage()">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="booksContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-6">
                        <!-- 图书卡片将在这里动态加载 -->
                    </div>
                </div>
            </div>

            <!-- Readers View -->
            <div id="readersView" class="hidden">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h2 class="text-xl font-semibold">读者列表</h2>
                    </div>
                    <div id="readersContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-6">
                        <!-- 读者卡片将在这里动态加载 -->
                    </div>
                </div>
            </div>

            <!-- Records View -->
            <div id="recordsView" class="hidden">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="p-4 border-b">
                        <h2 class="text-xl font-semibold">借阅记录</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">图书ID</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">读者ID</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">借阅日期</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">归还日期</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="recordsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Record rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑图书模态框 -->
    <div id="bookModal" class="modal fixed inset-0 z-50 flex items-center justify-center opacity-0 invisible">
        <div class="modal-overlay absolute inset-0 bg-black opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-close absolute top-0 right-0 cursor-pointer p-4">
                <i class="fas fa-times text-gray-500 hover:text-gray-700" onclick="closeModal('bookModal')"></i>
            </div>
            <div class="modal-content py-4 px-6">
                <div class="flex justify-between items-center pb-3">
                    <h3 class="text-xl font-bold" id="bookModalTitle">添加新图书</h3>
                </div>
                <form id="bookForm" onsubmit="saveData(event, 'books')">
                    <input type="hidden" id="bookId">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="book_id_form">图书ID</label>
                        <input type="text" id="book_id_form" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="book_isbn">ISBN</label>
                        <input type="text" id="book_isbn" name="book_isbn" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="book_name">书名</label>
                        <input type="text" id="book_name" name="book_name" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="book_author">作者</label>
                        <input type="text" id="book_author" name="book_author" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="book_publisher">出版社</label>
                        <input type="text" id="book_publisher" name="book_publisher" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="book_price">价格</label>
                        <input type="number" step="0.01" id="book_price" name="book_price" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="flex justify-end pt-2 space-x-4">
                        <button type="button" onclick="closeModal('bookModal')" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">取消</button>
                        <button type="submit" class="px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition flex items-center">
                            <i class="fas fa-save mr-2"></i>
                            <span id="saveButtonText">保存</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Reader Modal -->
    <div id="readerModal" class="modal fixed inset-0 z-50 flex items-center justify-center opacity-0 invisible">
        <div class="modal-overlay absolute inset-0 bg-black opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-close absolute top-0 right-0 cursor-pointer p-4">
                <i class="fas fa-times text-gray-500 hover:text-gray-700" onclick="closeModal('readerModal')"></i>
            </div>
            <div class="modal-content py-4 px-6">
                <div class="flex justify-between items-center pb-3">
                    <h3 class="text-xl font-bold" id="readerModalTitle">添加新读者</h3>
                </div>
                <form id="readerForm" onsubmit="saveData(event, 'readers')">
                    <input type="hidden" id="readerId">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="reader_id_form">读者ID</label>
                        <input type="text" id="reader_id_form" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="reader_name">姓名</label>
                        <input type="text" id="reader_name" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="reader_sex">性别</label>
                        <select id="reader_sex" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700">
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="reader_department">部门</label>
                        <input type="text" id="reader_department" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700">
                    </div>
                    <div class="flex justify-end pt-2 space-x-4">
                        <button type="button" onclick="closeModal('readerModal')" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg">取消</button>
                        <button type="submit" class="px-4 py-2 text-white bg-blue-600 rounded-lg">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Record Modal -->
    <div id="recordModal" class="modal fixed inset-0 z-50 flex items-center justify-center opacity-0 invisible">
        <div class="modal-overlay absolute inset-0 bg-black opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-close absolute top-0 right-0 cursor-pointer p-4">
                <i class="fas fa-times text-gray-500 hover:text-gray-700" onclick="closeModal('recordModal')"></i>
            </div>
            <div class="modal-content py-4 px-6">
                <div class="flex justify-between items-center pb-3">
                    <h3 class="text-xl font-bold" id="recordModalTitle">添加借阅记录</h3>
                </div>
                <form id="recordForm" onsubmit="saveData(event, 'records')">
                    <input type="hidden" id="recordId">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="record_book_id">图书ID</label>
                        <input type="text" id="record_book_id" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="record_reader_id">读者ID</label>
                        <input type="text" id="record_reader_id" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="borrow_date">借阅日期</label>
                        <input type="date" id="borrow_date" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="return_date">归还日期</label>
                        <input type="date" id="return_date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700">
                    </div>
                    <div class="flex justify-end pt-2 space-x-4">
                        <button type="button" onclick="closeModal('recordModal')" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg">取消</button>
                        <button type="submit" class="px-4 py-2 text-white bg-blue-600 rounded-lg">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 确认删除模态框 -->
    <div id="deleteModal" class="modal fixed inset-0 z-50 flex items-center justify-center opacity-0 invisible">
        <div class="modal-overlay absolute inset-0 bg-black opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 px-6 text-center">
                <divclass="pb-5">
                    <i class="fas fa-exclamation-circle text-red-500 text-5xl mb-4"></i>
                    <h3 class="text-xl font-bold" id="deleteModalTitle">确认删除</h3>
                    <p class="text-gray-600 mt-2" id="deleteModalText">您确定要删除这本书吗？此操作不可撤销。</p>
                </div>
                <div class="flex justify-center space-x-4">
                    <button onclick="closeModal('deleteModal')" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">取消</button>
                    <button id="confirmDeleteBtn" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition flex items-center">
                        <i class="fas fa-trash mr-2"></i>
                        确认删除
                    </button>
                </div>
                <input type="hidden" id="deleteId">
                <input type="hidden" id="deleteType">
            </div>
        </div>
    </div>

    <!-- 添加高级搜索模态框 -->
    <div id="advancedSearchModal" class="modal fixed inset-0 z-50 flex items-center justify-center opacity-0 invisible">
        <div class="modal-overlay absolute inset-0 bg-black opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-lg mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-close absolute top-0 right-0 cursor-pointer p-4">
                <i class="fas fa-times text-gray-500 hover:text-gray-700" onclick="closeModal('advancedSearchModal')"></i>
            </div>
            <div class="modal-content py-4 px-6">
                <div class="flex justify-between items-center pb-3">
                    <h3 class="text-xl font-bold">高级搜索</h3>
                </div>
                <form id="advancedSearchForm" onsubmit="advancedSearch(event)">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">搜索类型</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <label class="flex items-center">
                                <input type="radio" name="search_by" value="all" checked class="mr-2">
                                <span>全部</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="search_by" value="title" class="mr-2">
                                <span>书名</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="search_by" value="author" class="mr-2">
                                <span>作者</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="search_by" value="publisher" class="mr-2">
                                <span>出版社</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="search_by" value="isbn" class="mr-2">
                                <span>ISBN</span>
                            </label>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="search_keyword">关键词</label>
                        <input type="text" id="search_keyword" 
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                               placeholder="输入搜索关键词...">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">价格区间</label>
                        <div class="flex space-x-2">
                            <input type="number" id="min_price" step="0.01" min="0"
                                   class="shadow appearance-none border rounded w-1/2 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                   placeholder="最低价">
                            <span class="flex items-center">至</span>
                            <input type="number" id="max_price" step="0.01" min="0"
                                   class="shadow appearance-none border rounded w-1/2 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                   placeholder="最高价">
                        </div>
                    </div>
                    <div class="flex justify-end pt-2 space-x-4">
                        <button type="button" onclick="resetAdvancedSearch()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                            重置
                        </button>
                        <button type="submit" class="px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition flex items-center">
                            <i class="fas fa-search mr-2"></i>
                            搜索
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let apiBaseUrl = "http://localhost:8080/api"; 
        let currentView = 'books';

        const state = {
            books: [],
            readers: [],
            records: [],
            filteredBooks: [],
            currentPage: 1,
            itemsPerPage: 10,
        };
        
        // 加载数据
        async function loadData(type = 'books') {
            const loadingMessage = document.getElementById('loadingMessage');
            if(loadingMessage) loadingMessage.style.display = 'block';
            
            try {
                const response = await fetch(`${apiBaseUrl}/${type}`);
                if (!response.ok) throw new Error(`无法加载${type}数据`);
                
                const result = await response.json();
                state[type] = result.data || [];

                if (type === 'books') {
                    state.filteredBooks = [...state.books];
                }

                renderView(type);
                if (type === 'books') {
                    updateStats();
                }

            } catch (error) {
                console.error(`加载${type}失败:`, error);
                if(loadingMessage) loadingMessage.innerHTML = `<p class="text-red-500">加载失败: ${error.message}</p>`;
            } finally {
                if(loadingMessage) loadingMessage.style.display = 'none';
            }
        }

        function renderView(type, data) {
            if (type === 'books') {
                renderBooks(data || state.filteredBooks);
            } else if (type === 'readers') {
                renderReaders(data || state.readers);
            } else if (type === 'records') {
                renderRecords(data || state.records);
            }
        }

        // 保存数据（通用）
        function saveData(event, type) {
            event.preventDefault();
            
            const idInput = document.getElementById(`${type.slice(0, -1)}Id`);
            const id = idInput ? idInput.value : null;
            const isEdit = !!id;
            
            let body = {};
            let url = `${apiBaseUrl}/${type}`;

            if (type === 'books') {
                body = {
                    book_name: document.getElementById('book_name').value,
                    book_author: document.getElementById('book_author').value,
                    book_isbn: document.getElementById('book_isbn').value,
                    book_publisher: document.getElementById('book_publisher').value,
                    book_price: parseFloat(document.getElementById('book_price').value)
                };
                if (isEdit) {
                    body.book_id = id;
                    url = `${apiBaseUrl}/${type}/${id}`;
                } else {
                    body.book_id = document.getElementById('book_id_form').value;
                }
            } else if (type === 'readers') {
                body = {
                    reader_name: document.getElementById('reader_name').value,
                    reader_sex: document.getElementById('reader_sex').value,
                    reader_department: document.getElementById('reader_department').value,
                };
                 if (isEdit) {
                    body.reader_id = id;
                    url = `${apiBaseUrl}/${type}/${id}`;
                } else {
                    body.reader_id = document.getElementById('reader_id_form').value;
                }
            } else if (type === 'records') {
                body = {
                    book_id: document.getElementById('record_book_id').value,
                    reader_id: document.getElementById('record_reader_id').value,
                    borrow_date: document.getElementById('borrow_date').value,
                    return_date: document.getElementById('return_date').value || null,
                };
                 if (isEdit) {
                    const record = state.records.find(r => r.record_id === id);
                    if (record && record.book_id && record.reader_id) {
                        const original_book_id = record.book_id.trim();
                        const original_reader_id = record.reader_id.trim();
                        url = `${apiBaseUrl}/${type}/${original_book_id}/${original_reader_id}`;
                    } else {
                        showToast('错误：无法找到原始记录的关键信息，无法更新。', 'error');
                        return;
                    }
                }
            }

            // 显示加载状态
            const saveButton = event.target.querySelector('button[type="submit"]');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>保存中...';
            saveButton.disabled = true;

            fetch(url, {
                method: isEdit ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            })
            .then(async response => {
                const responseData = await response.json();

                if (!response.ok) {
                    // 检查是否是主键重复错误
                    if (response.status === 409) {
                        throw new Error(responseData.message || responseData.error || '主键重复');
                    } else {
                        throw new Error(responseData.error || responseData.message || '操作失败');
                    }
                }

                return responseData;
            })
            .then(data => {
                // 恢复按钮状态
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;

                // 显示成功消息
                showToast(data.message || '保存成功', 'success');

                // 关闭模态框并刷新数据
                closeModal(`${type.slice(0, -1)}Modal`);
                setTimeout(() => {
                    loadData(type);
                }, 500);
            })
            .catch(error => {
                // 恢复按钮状态
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;

                console.error("操作失败:", error);
                // 使用Toast显示错误
                showToast(`保存失败: ${error.message}`, 'error');
            });
        }

        // 删除数据（通用）
        async function confirmDelete() {
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const type = confirmBtn.dataset.type;
            let url;

            if (type === 'records') {
                const bookId = confirmBtn.dataset.bookId;
                const readerId = confirmBtn.dataset.readerId;
                url = `${apiBaseUrl}/${type}/${bookId}/${readerId}`;
            } else {
                const id = confirmBtn.dataset.id;
                url = `${apiBaseUrl}/${type}/${id}`;
            }
            
            try {
                const response = await fetch(url, { method: 'DELETE' });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to delete');
                }
                showToast('删除成功');
                closeModal('deleteModal');
                loadData(type);
            } catch (error) {
                console.error('Error deleting item:', error);
                showToast(`删除失败: ${error.message}`, 'error');
            }
        }

        function switchView(view) {
            currentView = view;
            document.querySelectorAll('[id$="View"]').forEach(v => v.classList.add('hidden'));
            document.getElementById(`${view}View`).classList.remove('hidden');

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                btn.classList.add('text-gray-500');
            });
            document.getElementById(`tab-${view}`).classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            
            document.getElementById('searchInput').placeholder = `搜索${{books:'图书', readers:'读者', records:'记录'}[view]}...`;
            document.getElementById('add-btn-text').textContent = ` 添加${{books:'图书', readers:'读者', records:'记录'}[view]}`;

            loadData(view);
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadData('books');
            // Link the confirm button in the delete modal to the confirmDelete function
            document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
        });

        // 打开删除确认模态框
        function openDeleteConfirmation(id, type) {
            const modal = document.getElementById('deleteModal');
            
            let item;
            if (type === 'records') {
                // For records, the 'id' is the temporary 'record_id'
                item = state[type].find(i => i.record_id === id);
            } else {
                // For books and readers, it's the actual ID
                item = state[type].find(i => i[`${type.slice(0, -1)}_id`] === id);
            }

            if (!item) {
                console.error('Item not found for deletion:', id, type);
                return;
            }

            // Store the necessary info on the confirm button
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            confirmBtn.dataset.type = type;

            if (type === 'records') {
                // For records, we need the composite key for the API call
                confirmBtn.dataset.bookId = item.book_id.trim();
                confirmBtn.dataset.readerId = item.reader_id.trim();
            } else {
                // For others, we use the simple ID
                confirmBtn.dataset.id = id;
            }
            
            const itemIdentifier = type === 'books' ? item.book_name : (type === 'readers' ? item.reader_name : `记录 (图书: ${item.book_id}, 读者: ${item.reader_id})`);
            document.getElementById('deleteModalText').textContent = `您确定要删除 "${itemIdentifier}" 吗？此操作不可撤销。`;

            openModal('deleteModal');
        }

        // 渲染图书
        function renderBooks() {
            const startIndex = (state.currentPage - 1) * state.itemsPerPage;
            const endIndex = startIndex + state.itemsPerPage;
            const booksToShow = state.filteredBooks.slice(startIndex, endIndex);
            
            const booksContainer = document.getElementById('booksContainer');
            booksContainer.innerHTML = '';
            
            if (booksToShow.length === 0) {
                booksContainer.innerHTML = `<div class="col-span-full text-center py-10 text-gray-500"><p>没有找到图书</p></div>`;
            } else {
                booksToShow.forEach(book => {
                    const card = createBookCard(book);
                    booksContainer.appendChild(card);
                });
            }
            updatePaginationControls();
        }

        // 渲染读者
        function renderReaders(readers) {
            const readersContainer = document.getElementById('readersContainer');
            readersContainer.innerHTML = '';
            if (!readers || readers.length === 0) {
                readersContainer.innerHTML = `<div class="col-span-full text-center py-10 text-gray-500"><p>没有读者信息</p></div>`;
                return;
            }
            readers.forEach(reader => {
                const card = createReaderCard(reader);
                readersContainer.appendChild(card);
            });
        }

        // 渲染记录
        function renderRecords(records) {
            const recordsBody = document.getElementById('recordsTableBody');
            recordsBody.innerHTML = '';
            if (!records || records.length === 0) {
                recordsBody.innerHTML = `<tr><td colspan="5" class="text-center py-4">没有借阅记录</td></tr>`;
                return;
            }
            records.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    
                    <td class="px-6 py-4 whitespace-nowrap">${record.book_id}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${record.reader_id}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${record.borrow_date ? new Date(record.borrow_date).toLocaleDateString() : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${record.return_date ? new Date(record.return_date).toLocaleDateString() : '未归还'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="openEditModal('${record.record_id}', 'records')" class="text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button>
                        <button onclick="openDeleteConfirmation('${record.record_id}', 'records')" class="text-red-600 hover:text-red-800 ml-2"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
                recordsBody.appendChild(row);
            });
        }

        // 创建读者卡片
        function createReaderCard(reader) {
            const card = document.createElement('div');
            card.className = 'book-card bg-white rounded-lg shadow overflow-hidden flex flex-col';
            card.innerHTML = `
                <div class="h-48 bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center">
                    <i class="fas fa-user text-white text-6xl"></i>
                </div>
                <div class="p-6 flex-grow flex flex-col">
                    <h3 class="text-xl font-bold truncate mb-2" title="${reader.reader_name}">${reader.reader_name} (ID: ${reader.reader_id})</h3>
                    <p class="text-gray-600 mb-1"><i class="fas fa-venus-mars text-sm mr-2"></i>${reader.reader_sex}</p>
                    <p class="text-gray-600 mb-3"><i class="fas fa-building text-sm mr-2"></i>${reader.reader_department}</p>
                    <div class="flex-grow"></div>
                    <div class="flex justify-end space-x-2 mt-4">
                        <button onclick="openEditModal('${reader.reader_id}', 'readers')" class="text-blue-600 hover:text-blue-800 transition"><i class="fas fa-edit"></i></button>
                        <button onclick="openDeleteConfirmation('${reader.reader_id}', 'readers')" class="text-red-600 hover:text-red-800 transition"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            `;
            return card;
        }

        // 创建图书卡片
        function createBookCard(book) {
            const card = document.createElement('div');
            card.className = 'book-card bg-white rounded-lg shadow overflow-hidden flex flex-col';
            card.innerHTML = `
                <div class="h-48 bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center">
                    <i class="fas fa-book-open text-white text-6xl"></i>
                </div>
                <div class="p-6 flex-grow flex flex-col">
                    <h3 class="text-xl font-bold truncate mb-2" title="${book.book_name}">${book.book_name} (ID: ${book.book_id})</h3>
                    <p class="text-gray-600 mb-1"><i class="fas fa-user text-sm mr-2"></i>${book.book_author}</p>
                    <p class="text-gray-600 mb-1"><i class="fas fa-barcode text-sm mr-2"></i>${book.book_isbn}</p>
                    <p class="text-gray-800 font-semibold mb-3"><i class="fas fa-money-bill-wave text-sm mr-2"></i>¥${book.book_price.toFixed(2)}</p>
                    <div class="flex-grow"></div>
                    <div class="flex justify-end space-x-2 mt-4">
                        <button onclick="openEditModal('${book.book_id}', 'books')" class="text-blue-600 hover:text-blue-800 transition"><i class="fas fa-edit"></i></button>
                        <button onclick="openDeleteConfirmation('${book.book_id}', 'books')" class="text-red-600 hover:text-red-800 transition"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            `;
            return card;
        }

        // 更新统计信息
        function updateStats() {
            document.getElementById('totalBooks').textContent = state.filteredBooks.length;
            // The rest of the stats are placeholders for now
            document.getElementById('availableBooks').textContent = '-';
            document.getElementById('borrowedBooks').textContent = '-';
            document.getElementById('popularCategory').textContent = '-';
        }

        // 分页控件更新
        function updatePaginationControls() {
            const totalPages = Math.ceil(state.filteredBooks.length / state.itemsPerPage);
            document.getElementById('pageInfo').textContent = `${state.currentPage} / ${totalPages || 1}`;
            document.getElementById('prevPage').disabled = state.currentPage === 1;
            document.getElementById('nextPage').disabled = state.currentPage >= totalPages;
        }

        // 上一页
        function previousPage() {
            if (state.currentPage > 1) {
                state.currentPage--;
                renderBooks();
            }
        }

        // 下一页
        function nextPage() {
            const totalPages = Math.ceil(state.filteredBooks.length / state.itemsPerPage);
            if (state.currentPage < totalPages) {
                state.currentPage++;
                renderBooks();
            }
        }

        // 更改每页显示数量
        function changeItemsPerPage() {
            state.itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
            state.currentPage = 1;
            renderBooks();
        }

        // 搜索
        function searchData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (currentView === 'books') {
                if (searchTerm === '') {
                    state.filteredBooks = [...state.books];
                } else {
                    state.filteredBooks = state.books.filter(item =>
                        (item.book_name && item.book_name.toLowerCase().includes(searchTerm)) ||
                        (item.book_author && item.book_author.toLowerCase().includes(searchTerm)) ||
                        (item.book_isbn && item.book_isbn.toLowerCase().includes(searchTerm)) ||
                        (item.book_id && item.book_id.toLowerCase().includes(searchTerm))
                    );
                }
                state.currentPage = 1;
                renderBooks();
                updateStats();
            } else if (currentView === 'readers') {
                const filteredData = searchTerm === '' ? state.readers : state.readers.filter(item =>
                    (item.reader_name && item.reader_name.toLowerCase().includes(searchTerm)) ||
                    (item.reader_department && item.reader_department.toLowerCase().includes(searchTerm)) ||
                    (item.reader_id && item.reader_id.toLowerCase().includes(searchTerm))
                );
                renderReaders(filteredData);
            } else if (currentView === 'records') {
                const filteredData = searchTerm === '' ? state.records : state.records.filter(record =>
                    (record.book_id && record.book_id.toLowerCase().includes(searchTerm)) ||
                    (record.reader_id && record.reader_id.toLowerCase().includes(searchTerm))
                );
                renderRecords(filteredData);
            }
        }

        // 打开添加模态框
        function openAddModal() {
            const type = currentView;
            const formId = `${type.slice(0, -1)}Form`;
            const modalId = `${type.slice(0, -1)}Modal`;
            
            // 重置表单
            document.getElementById(formId).reset();
            
            // 确保清空所有隐藏的ID字段
            if (type === 'books') {
                // 清空隐藏的bookId字段
                document.getElementById('bookId').value = '';
                const bookIdInput = document.getElementById('book_id_form');
                bookIdInput.disabled = false;
                bookIdInput.value = ''; // 确保输入框值为空
                
                // 清空其他可能的缓存
                document.getElementById('book_isbn').value = '';
                document.getElementById('book_name').value = '';
                document.getElementById('book_author').value = '';
                document.getElementById('book_publisher').value = '';
                document.getElementById('book_price').value = '';
                
            } else if (type === 'readers') {
                document.getElementById('readerId').value = '';
                const readerIdInput = document.getElementById('reader_id_form');
                if(readerIdInput) {
                    readerIdInput.disabled = false;
                    readerIdInput.value = '';
                }
            } else if (type === 'records') {
                document.getElementById('recordId').value = '';
                document.getElementById('record_book_id').disabled = false;
                document.getElementById('record_reader_id').disabled = false;
                document.getElementById('record_book_id').value = '';
                document.getElementById('record_reader_id').value = '';
            }

            document.getElementById(`${modalId}Title`).textContent = `添加 ${getChineseName(type)}`;
            
            // 重置保存按钮文本（如果是编辑后状态）
            if (type === 'books') {
                document.getElementById('saveButtonText').textContent = '保存';
            }
            
            openModal(modalId);
        }

        // 打开编辑模态框
        function openEditModal(id, type) {
            const item = state[type].find(i => i[`${type.slice(0, -1)}_id`] === id);
            if (!item) return;

            const modalId = `${type.slice(0, -1)}Modal`;
            
            if (type === 'books') {
                document.getElementById('bookId').value = item.book_id;
                const bookIdInput = document.getElementById('book_id_form');
                bookIdInput.value = item.book_id;
                bookIdInput.disabled = true;
                document.getElementById('book_name').value = item.book_name;
                document.getElementById('book_author').value = item.book_author;
                document.getElementById('book_isbn').value = item.book_isbn;
                document.getElementById('book_publisher').value = item.book_publisher;
                document.getElementById('book_price').value = item.book_price;
            } else if (type === 'readers') {
                document.getElementById('readerId').value = item.reader_id;
                const readerIdInput = document.getElementById('reader_id_form');
                readerIdInput.value = item.reader_id;
                readerIdInput.disabled = true;
                document.getElementById('reader_name').value = item.reader_name;
                document.getElementById('reader_sex').value = item.reader_sex;
                document.getElementById('reader_department').value = item.reader_department;
            } else if (type === 'records') {
                document.getElementById('recordId').value = item.record_id;
                const bookIdInput = document.getElementById('record_book_id');
                const readerIdInput = document.getElementById('record_reader_id');
                
                bookIdInput.value = item.book_id.trim();
                readerIdInput.value = item.reader_id.trim();
                
                bookIdInput.disabled = true;
                readerIdInput.disabled = true;

                document.getElementById('borrow_date').value = item.borrow_date.split('T')[0];
                document.getElementById('return_date').value = item.return_date ? item.return_date.split('T')[0] : '';
            }

            document.getElementById(`${modalId}Title`).textContent = `编辑 ${getChineseName(type)}`;
            openModal(modalId);
        }

        // 关闭模态框
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.classList.remove('opacity-100', 'visible');
            modal.classList.add('opacity-0', 'invisible');
            
            // Check if any other modal is open before removing blur
            const anyModalOpen = Array.from(document.querySelectorAll('.modal')).some(m => m.classList.contains('visible'));
            if (!anyModalOpen) {
                document.getElementById('mainContent').classList.remove('blur-background');
            }
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.classList.remove('opacity-0', 'invisible');
            modal.classList.add('opacity-100', 'visible');
            document.getElementById('mainContent').classList.add('blur-background');
        }

        // 关闭删除模态框
        function closeDeleteModal() {
            closeModal('deleteModal');
        }

        function getChineseName(type) {
            const names = {
                books: '图书',
                readers: '读者',
                records: '记录'
            };
            return names[type] || '项目';
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
            toast.className = `fixed bottom-5 right-5 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300`;
            toast.textContent = message;
            document.body.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-y-20', 'opacity-0');
            }, 100);

            // Animate out and remove
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // 高级搜索
        function openAdvancedSearch() {
            document.getElementById('search_keyword').value = '';
            document.getElementById('min_price').value = '';
            document.getElementById('max_price').value = '';

            // Reset radio buttons
            const radioButtons = document.querySelectorAll('input[name="search_by"]');
            radioButtons.forEach(radio => {
                radio.checked = (radio.value === 'all');
            });

            openModal('advancedSearchModal');
        }

        function resetAdvancedSearch() {
            document.getElementById('search_keyword').value = '';
            document.getElementById('min_price').value = '';
            document.getElementById('max_price').value = '';

            // Reset radio buttons
            const radioButtons = document.querySelectorAll('input[name="search_by"]');
            radioButtons.forEach(radio => {
                radio.checked = (radio.value === 'all');
            });
        }

        // 修改高级搜索函数，使用后端API
        async function advancedSearch(event) {
            if (event) event.preventDefault();
            
            const keyword = document.getElementById('search_keyword').value.trim();
            const searchBy = document.querySelector('input[name="search_by"]:checked').value;
            const minPrice = document.getElementById('min_price').value;
            const maxPrice = document.getElementById('max_price').value;
            
            // 构建查询参数
            const params = new URLSearchParams();
            if (keyword) params.append('keyword', keyword);
            if (searchBy) params.append('search_by', searchBy);
            if (minPrice) params.append('min_price', minPrice);
            if (maxPrice) params.append('max_price', maxPrice);
            
            try {
                const response = await fetch(`${apiBaseUrl}/books/search?${params.toString()}`);
                if (!response.ok) throw new Error('搜索失败');
                
                const result = await response.json();
                state.books = result.data || [];
                state.filteredBooks = [...state.books];
                state.currentPage = 1;
                
                renderBooks();
                updateStats();
                closeModal('advancedSearchModal');
                
                // 显示搜索结果摘要
                showSearchSummary(result);
                
            } catch (error) {
                console.error('高级搜索失败:', error);
                showToast(`搜索失败: ${error.message}`, 'error');
            }
        }

        // 添加显示搜索结果摘要的函数
        function showSearchSummary(result) {
            const summary = document.createElement('div');
            summary.className = 'bg-blue-50 border-l-4 border-blue-500 p-4 mb-4 rounded shadow-sm';
            
            let summaryText = '搜索结果: ';
            
            if (result.keyword) {
                summaryText += `关键词 "${result.keyword}" `;
            }
            
            if (result.search_by && result.search_by !== 'all') {
                const searchTypeMap = {
                    'title': '书名',
                    'author': '作者',
                    'publisher': '出版社',
                    'isbn': 'ISBN'
                };
                summaryText += `(按${searchTypeMap[result.search_by]}) `;
            }
            
            if (result.min_price || result.max_price) {
                summaryText += `价格区间: `;
                if (result.min_price) summaryText += `¥${result.min_price}以上`;
                if (result.min_price && result.max_price) summaryText += ' - ';
                if (result.max_price) summaryText += `¥${result.max_price}以下`;
                summaryText += ' ';
            }
            
            summaryText += `共找到 ${result.total || 0} 条结果`;
            
            summary.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-blue-700 font-medium">${summaryText}</p>
                    </div>
                    <button onclick="clearSearch()" class="text-blue-600 hover:text-blue-800 text-sm">
                        <i class="fas fa-times mr-1"></i>清除搜索
                    </button>
                </div>
            `;
            
            // 插入到图书列表上方
            const booksView = document.getElementById('booksView');
            const existingSummary = booksView.querySelector('.search-summary');
            if (existingSummary) {
                existingSummary.remove();
            }
            
            summary.classList.add('search-summary');
            const booksContainer = booksView.querySelector('.bg-white.rounded-lg.shadow');
            booksView.insertBefore(summary, booksContainer);
        }

        // 清除搜索结果
        function clearSearch() {
            loadData('books');
            const booksView = document.getElementById('booksView');
            const existingSummary = booksView.querySelector('.search-summary');
            if (existingSummary) {
                existingSummary.remove();
            }
        }
    </script>
</body>
</html>